<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<!------ Include the above in your HEAD tag ---------->


<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  </head>
  <!------ Include the above in your HEAD tag ---------->
  <body id="LoginForm">
  <div class="container">
    <h1 class="form-heading">login Form</h1>
    <div class="login-form">
      <div class="main-div">
        <div class="panel">
          <h2>Login</h2>
          <p>Por favor ingrese su usuario y contraseña</p>
        </div>
        <form id="Login" action="login.php" method="post">
          <div class="form-group">
              <input type="text" class="form-control" id="Usuario" placeholder="Usuario" required autocomplete="off">
          </div>
          <div class="form-group">
              <input type="password" class="form-control" id="Password" placeholder="Contraseña" required autocomplete="off">
          </div>
          <button type="button" class="btn btn-primary" id="BotonLogin">Iniciar Sesion</button>
          <div class="usuarioNuevo">
            <a href="#" id="NuevoUsuario">Registrar nuevo usuario</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- formulario de eventos -->
  <div class="modal fade" id="FormNuevoUsuario" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="Id">
          <div class="form-row">
            <div class="form-group col-md-12">
              <label for="">Nombre de usuario:</label>
              <input type="text" id="NombreNuevo" class="form-control" placeholder="Nuevo Usuario" autocomplete="off">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-12">
              <label for="">Contraseña:</label>
              <input type="password" id="Clave1" class="form-control" value="" autocomplete="off" placeholder="Contraseña">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-12">
              <label for="">Repita la contraseña:</label>
              <div class="input-group clockpicker" data-autoclose="true">
                <input type="password" id="Clave2" class="form-control" value="" autocomplete="off" placeholder="Confirmar contraseña">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="BotonAgregarUsuario" class="btn btn-info">Agregar</button>
          <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>

    document.addEventListener('DOMContentLoaded', function(){

      //Funciones de botones
      $('#NuevoUsuario').click(function(){
        borrarFormulario();
        $('#FormNuevoUsuario').modal('show');
      });

      $('#BotonAgregarUsuario').click(function(){
        let nuevoUsuario = retornarNuevoUsuario();
        if(validarEntradaDatos(nuevoUsuario)){
          agregarNuevoUsuario(nuevoUsuario);
        }
      });

      $('#BotonLogin').click(function(){
        let usuario = retornarUsuario();
        loginUsuario(usuario);
      });

      //Funciones de Formulario
      function borrarFormulario(){
        $('#NombreNuevo').val('');
        $('#Clave1').val('');
        $('#Clave2').val('');
      }

      function retornarNuevoUsuario(){
        let nuevoUsuario = {
          nombrenuevo: $('#NombreNuevo').val(),
          clave1: $('#Clave1').val(),
          clave2: $('#Clave2').val()
        }
        return nuevoUsuario;
      }

      function retornarUsuario(){
        let usuario = {
          usuario: $('#Usuario').val(),
          password: $('#Password').val()
        }
        return usuario;
      }

      function validarEntradaDatos(nuevousuario){
        if(nuevousuario.nombrenuevo == ''){
          alert('debes ingresar un nombre de usuario')
          return false;
        }

        if(nuevousuario.clave1 == ''){
          alert('debes ingresar una contraseña')
          return false;
        }

        if(nuevousuario.clave1 != nuevousuario.clave2){
          alert('las claves ingresadas no coinciden');
          return false;
        }
        return true;
      }

      //Funciones AJAX

      function loginUsuario(usuario){
        $.ajax({
          type: 'POST',
          url: 'login.php',
          data: usuario,
          success: function(respuesta){
            if(respuesta == 'Correcto'){
              window.location = 'departamento.php';
            }else{
              alert('Nombre o Contraseña incorrectas');
            }
          },
          error: function(){
            alert('hubo un error');
          }
        });
      }

      function agregarNuevoUsuario(nuevousuario){
        $.ajax({
          type: 'POST',
          url: 'datosusuarios.php?accion=existe',
          data: nuevousuario,
          success: function(info){
            if(info.resultado == 'norepetido'){
              $.ajax({
                type: 'POST',
                url: 'datosusuarios.php?accion=agregar',
                data: nuevousuario,
                success: function(){
                  alert('se agrego el nuevo usuario')
                  $('#FormNuevoUsuario').modal('hide');
                },
                error: function(err){
                  console.log('error de q?', err);
                  alert('ocurrio un error');
                }
              });
            }else{
              alert('usuario existente');
            }
          },
          error: function(){
            alert('ocurrio un error');
          }
        });
      };
    });


  </script>


  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
  </body>
</html>
